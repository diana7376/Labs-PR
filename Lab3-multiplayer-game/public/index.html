<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Scramble - MIT 6.102 Lab 3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #d9d0d4 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .title-bar button {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            margin-left: 8px;
            padding: 0;
            transition: background 0.2s, box-shadow 0.2s;
        }

        .title-bar button[title="Show help"] {
            background: #ffd6ef;
            color: #ff69b4;
            font-size: 1.45em;
            box-shadow: 0 0 4px #f1e6f3;
        }

        .title-bar button[title="Game settings"] {
            background: #dbeafe;
            color: #2563eb;
            font-size: 1.35em;
            box-shadow: 0 0 4px #c7dbeb;
        }

        .title-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .title-bar h1 {
            margin: 0;
            flex-grow: 1;
            text-align: center;
            color: #000000;
        }
        
        .container {
          backdrop-filter: blur(8px);
          border-radius: 20px;
          padding: 30px;
          max-width: 800px;
          width: 100%;
          transition: box-shadow 0.3s;
        }

        button {
            padding: 12px 24px;
            color: black;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        button.refresh{
        background: linear-gradient(90deg, #ff9a9e 0%, #fbb1b1 100%);
        color: white;
        }
        button.new-game {
        background: linear-gradient(90deg, #ff9a9e 0%, #fbb1b1 100%);
        color: white;
        }
        button:hover {
          background: linear-gradient(90deg, #ff69b4 20%, #e75480 100%);
          transform: translateY(-2px) scale(1.05);
          box-shadow: 0 8px 24px rgba(255,182,193,0.22);
        }

        h1 {
            text-align: center;
            color: #ff69b4;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ff69b4;
        }

        .modal-header h2 {
            color: #ff69b4;
            margin: 0;
            font-size: 1.8em;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s;
        }

        .close:hover,
        .close:focus {
            color: #ff69b4;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-left: 4px solid #ff69b4;
            padding-left: 10px;
        }

        .modal-section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .modal-section ul {
            color: #666;
            line-height: 1.6;
            padding-left: 20px;
        }

        .modal-section li {
            margin-bottom: 8px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            font-size: 0.9em;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .legend-box {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2em;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .legend-box.face-down {
            background: linear-gradient(135deg, #ffb6c1 0%, #ff69b4 100%);
        }

        .legend-box.temporary {
            background: linear-gradient(135deg, #FFD93D 0%, #FFA500 100%);
            border: 3px solid #FF8C00;
            color: #333;
        }

        .legend-box.matched {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            border: 3px solid #1B5E20;
        }

        .legend-description {
            display: flex;
            flex-direction: column;
        }

        .legend-description strong {
            color: #333;
            margin-bottom: 2px;
        }

        .legend-description small {
            color: #666;
            font-size: 0.85em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        label {
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="number"] {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #ff69b4;
        }

        button:active {
            transform: translateY(0);
        }

        .info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .info div {
            font-weight: 600;
            color: #333;
        }

        .info span {
            color: #ff69b4;
            font-size: 1.2em;
        }

        #game-board {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .board-row {
            display: flex;
            gap: 10px;
        }

        .card {
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Face-down cards (default) */
        .card {
            background: linear-gradient(135deg, #ffb6c1 0%, #ff69b4 100%);
            color: white;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        /* Face-up but NOT matched (temporary) - Yellow */
        .card.face-up {
            background: linear-gradient(135deg, #FFD93D 0%, #FFA500 100%);
            color: #333;
            border: 3px solid #FF8C00;
            animation: flipIn 0.3s ease-out;
        }

        /* Matched cards (controlled by player) - Green */
        .card.matched {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            border: 3px solid #1B5E20;
            cursor: not-allowed;
            animation: matchPulse 0.5s ease-out;
        }

        /* Removed cards (matched pair removed from board) */
        .card.removed {
            background: transparent;
            border: 2px dashed #ddd;
            color: #ddd;
            cursor: not-allowed;
            pointer-events: none;
            opacity: 0.5;
            transform: scale(0.9);
        }

        @keyframes flipIn {
            from {
                transform: rotateY(90deg);
            }
            to {
                transform: rotateY(0deg);
            }
        }

        @keyframes matchPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .status {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 600;
            color: #333;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title-bar">
            <button onclick="showModal()" title="Show help">?</button>
            <h1>Memory Scramble</h1>
            <button onclick="showSettings()" title="Game settings"><span>&#9881;</span></button>
        </div>

        <div class="info">
            <div>Player: <span id="current-player">player1</span></div>
            <div>Score: <span id="score">0</span></div>
            <div>Board: <span id="board-size">4x4</span></div>
        </div>

        <div id="game-board"></div>

        <div id="status" class="status">Click the settings gear ‚öôÔ∏è to configure and start a new game!</div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üéÆ Memory Scramble Help</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <div class="modal-section">
                <h3>üéØ How to Play</h3>
                <p>Memory Scramble is a classic memory matching game where you flip cards to find matching pairs!</p>
                <ul>
                    <li><strong>Goal:</strong> Find all matching pairs on the board</li>
                    <li><strong>Click</strong> any face-down card to flip it and reveal its symbol</li>
                    <li><strong>Match:</strong> When you find two matching cards, they stay face-up and you earn a point</li>
                    <li><strong>Win:</strong> Match all pairs to complete the game!</li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>üéÆ Game Controls</h3>
                <ul>
                    <li><strong>Player ID:</strong> Set your unique player identifier</li>
                    <li><strong>Board Size:</strong> Customize the game board dimensions (2x2 to 10x10)</li>
                    <li><strong>New Game:</strong> Start a fresh game with current settings</li>
                    <li><strong>Refresh:</strong> Update the board to see the latest game state</li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>üé® Card States</h3>
                <p>Understanding the different card colors and what they mean:</p>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box face-down">?</div>
                        <div class="legend-description">
                            <strong>Face Down (Pink)</strong>
                            <small>Hidden card ready to flip</small>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box temporary">A</div>
                        <div class="legend-description">
                            <strong>Flipped (Yellow)</strong>
                            <small>Temporarily revealed card</small>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div style="width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: transparent; border: 2px dashed #ddd; color: #ddd; font-size: 1.2em; opacity: 0.5; transform: scale(0.9);">‚úì</div>
                        <div class="legend-description">
                            <strong>Matched (Removed)</strong>
                            <small>Cleared from board</small>
                        </div>
                    </div>
                </div>
                <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                    <strong>Visual Guide:</strong><br>
                    ‚Ä¢ <span style="color: #ff69b4; font-weight: bold;">Pink cards</span> are face-down and can be clicked<br>
                    ‚Ä¢ <span style="color: #FF8C00; font-weight: bold;">Yellow cards</span> are temporarily flipped (waiting for a match)<br>
                    ‚Ä¢ <span style="color: #ddd; font-weight: bold;">Faded checkmarks</span> show where matched pairs were removed
                </p>
            </div>

            <div class="modal-section">
                <h3>üí° Tips for Success</h3>
                <ul>
                    <li>Pay attention to the symbols and their locations</li>
                    <li>Try to remember where you've seen each symbol</li>
                    <li>Start with smaller boards (4x4) and work your way up</li>
                    <li>Take your time - there's no rush!</li>
                </ul>
            </div>

            <div class="modal-section">
                <h3>üèÜ Scoring</h3>
                <p>You earn <strong>1 point</strong> for each matched pair. Your goal is to find all pairs with the best memory skills possible!</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Game Settings</h2>
                <span class="close" onclick="closeSettingsModal()">&times;</span>
            </div>
            
            <div class="modal-section">
                <h3>üéØ Board Configuration</h3>
                <p>Customize your game board size for different difficulty levels:</p>
                
                <div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap; justify-content: center;">
                    <div class="input-group">
                        <label for="settings-width">Board Width:</label>
                        <input type="number" id="settings-width" value="4" min="2" max="10" style="width: 80px;">
                    </div>
                    <div class="input-group">
                        <label for="settings-height">Board Height:</label>
                        <input type="number" id="settings-height" value="4" min="2" max="10" style="width: 80px;">
                    </div>
                </div>

                <div style="margin: 20px 0; text-align: center;">
                    <p style="color: #666; font-size: 0.9em;">
                        <strong>Current Board:</strong> <span id="settings-board-preview">4x4 (16 cards)</span>
                    </p>
                </div>
            </div>

            <div class="modal-section">
                <h3>üìè Difficulty Guide</h3>
                <ul style="font-size: 0.9em;">
                    <li><strong>2x2 to 3x3:</strong> Beginner level (4-9 cards)</li>
                    <li><strong>4x4 to 5x5:</strong> Intermediate level (16-25 cards)</li>
                    <li><strong>6x6 to 8x8:</strong> Advanced level (36-64 cards)</li>
                    <li><strong>9x9 to 10x10:</strong> Expert level (81-100 cards)</li>
                </ul>
                <p style="color: #666; font-size: 0.85em; margin-top: 10px;">
                    <em>Note: Larger boards require more memory and concentration!</em>
                </p>
            </div>

            <div class="modal-section">
                <h3>üíæ Player Settings</h3>
                <div class="input-group" style="justify-content: center; margin: 15px 0;">
                    <label for="settings-player-id">Player ID:</label>
                    <input type="text" id="settings-player-id" value="player1" placeholder="Enter your ID" style="width: 150px;">
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #ff69b4;">
                <button onclick="applySettings()" style="background: linear-gradient(90deg, #ff9a9e 0%, #fbb1b1 100%); color: white; padding: 12px 30px; margin-right: 10px;">
                    Apply & Start New Game
                </button>
                <button onclick="closeSettingsModal()" style="background: #f0f0f0; color: #666; padding: 12px 30px;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentGameId = null;
        let playerId = 'player1';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Update player display on page load
            document.getElementById('current-player').textContent = playerId;
        });

        // Modal functions
        function showModal() {
            document.getElementById('helpModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        function showSettings() {
            // Sync current values to settings modal (use defaults if no game started)
            document.getElementById('settings-width').value = 4;
            document.getElementById('settings-height').value = 4;
            document.getElementById('settings-player-id').value = playerId;
            updateSettingsPreview();
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        async function applySettings() {
            // Apply settings from modal to start new game
            const width = parseInt(document.getElementById('settings-width').value);
            const height = parseInt(document.getElementById('settings-height').value);
            const playerIdValue = document.getElementById('settings-player-id').value;
            
            // Update player display
            playerId = playerIdValue;
            document.getElementById('current-player').textContent = playerId;
            document.getElementById('board-size').textContent = `${width}x${height}`;
            
            try {
                const response = await fetch(`${API_URL}/games/new`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ width, height, player_id: playerId })
                });

                const data = await response.json();

                if (data.ok) {
                    currentGameId = data.game_id;
                    showStatus('Settings applied! New game started!', 'success');
                    renderBoard(data.board);
                    updateScore(data.scores);
                    closeSettingsModal();
                } else {
                    showStatus('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('Failed to apply settings: ' + error.message, 'error');
            }
        }

        function updateSettingsPreview() {
            const width = document.getElementById('settings-width').value;
            const height = document.getElementById('settings-height').value;
            const totalCards = width * height;
            document.getElementById('settings-board-preview').textContent = `${width}x${height} (${totalCards} cards)`;
        }

        // Add event listeners for real-time preview updates
        document.addEventListener('DOMContentLoaded', function() {
            const settingsWidth = document.getElementById('settings-width');
            const settingsHeight = document.getElementById('settings-height');
            
            if (settingsWidth && settingsHeight) {
                settingsWidth.addEventListener('input', updateSettingsPreview);
                settingsHeight.addEventListener('input', updateSettingsPreview);
            }
        });

        // Close modals when clicking outside of them
        window.onclick = function(event) {
            const helpModal = document.getElementById('helpModal');
            const settingsModal = document.getElementById('settingsModal');
            if (event.target === helpModal) {
                closeModal();
            } else if (event.target === settingsModal) {
                closeSettingsModal();
            }
        }

        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeSettingsModal();
            }
        });

        async function newGame() {
            const width = parseInt(document.getElementById('board-width').value);
            const height = parseInt(document.getElementById('board-height').value);
            playerId = document.getElementById('player-id').value;

            try {
                const response = await fetch(`${API_URL}/games/new`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ width, height, player_id: playerId })
});



                const data = await response.json();

                if (data.ok) {
                    currentGameId = data.game_id;
                    document.getElementById('board-size').textContent = `${width}x${height}`;
                    showStatus('Game started! Find matching pairs!', 'success');
                    renderBoard(data.board);
                    updateScore(data.scores);
                } else {
                    showStatus('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('Failed to create game: ' + error.message, 'error');
            }
        }

        async function flipCard(row, col) {
    if (!currentGameId) {
        showStatus('Start a new game first!', 'error');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/games/${currentGameId}/flip`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                player_id: playerId,
                row: row,
                column: col
            })
        });

        const data = await response.json();

        if (data.ok) {
            renderBoard(data.board);
            updateScore(data.scores);
            if (data.game_over) {
                showStatus(`üéâ Congratulations, ${playerId}! You matched all pairs!`, 'success');
            } else {
                showStatus('Card flipped!', 'success');
            }
        } else {
            showStatus('Error: ' + data.message, 'error');
        }
    } catch (error) {
        showStatus('Failed to flip card: ' + error.message, 'error');
    }
}


       async function refreshBoard() {
    if (!currentGameId) {
        showStatus('Start a new game first!', 'error');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/games/${currentGameId}/look?player_id=${playerId}`);
        const data = await response.json();

        if (data.ok) {
            renderBoard(data.board);
            updateScore(data.scores);
            if (data.game_over) {
                showStatus(`üéâ Congratulations, ${playerId}! You matched all pairs!`, 'success');
            } else {
                showStatus('Card flipped!', 'success');
            }
        } else {
            showStatus('Error: ' + data.message, 'error');
        }
    } catch (error) {
        showStatus('Refresh failed: ' + error.message, 'error');
    }
}

        function renderBoard(boardData) {
            const boardElement = document.getElementById('game-board');
            boardElement.innerHTML = '';

            boardData.forEach((row, y) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'board-row';

                row.forEach((space, x) => {
                    const card = document.createElement('div');
                    card.className = 'card';

                    // CRITICAL FIX: Check controlled_by for true matches
                    if (space.card === null) {
                        // Card was removed (matched pair removed from board)
                        card.classList.add('removed');
                        card.textContent = '‚úì';
                    } else if (space.controlled_by !== null && space.controlled_by !== undefined) {
                        // Card is MATCHED and controlled by a player (GREEN)
                        card.classList.add('matched');
                        card.textContent = space.card;
                    } else if (space.is_face_up) {
                        // Card is face-up but NOT matched (temporary - YELLOW)
                        card.classList.add('face-up');
                        card.textContent = space.card;
                    } else {
                        // Card is face-down (BLUE)
                        card.textContent = '?';
                    }

                    // Click handler - only allow clicks on non-matched, non-removed cards
                    if (!card.classList.contains('matched') && !card.classList.contains('removed')) {
                        card.addEventListener('click', () => flipCard(y, x));
                    }

                    rowDiv.appendChild(card);
                });

                boardElement.appendChild(rowDiv);
            });
        }

        function updateScore(scores) {
            const playerScore = scores[playerId] || 0;
            document.getElementById('score').textContent = playerScore;
        }

        function showStatus(message, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = 'status' + (type ? ' ' + type : '');
        }

        // Update board preview text in settings modal
        function updateBoardPreview(width, height) {
            const previewElement = document.getElementById('settings-board-preview');
            previewElement.textContent = `${width}x${height} (${width * height} cards)`;
        }

        // Event listeners for settings inputs
        document.getElementById('settings-width').addEventListener('input', (e) => {
            updateBoardPreview(e.target.value, document.getElementById('settings-height').value);
        });

        document.getElementById('settings-height').addEventListener('input', (e) => {
            updateBoardPreview(document.getElementById('settings-width').value, e.target.value);
        });

    </script>
</body>
</html>
